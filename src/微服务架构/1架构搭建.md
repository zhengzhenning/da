---
title: 架构搭建
order: 2
icon: file
category:
  - 微服务	
  - 架构
  - 框架
  - 搭建
---

> [!important]
>
> `sqshq/piggymetrics` 用于学习和了解微服务架构
>
> Microservice Architecture with Spring Boot, Spring Cloud and Docker

基于 [piggymetrics](https://github.com/sqshq/piggymetrics  ) 搭建微服务，以  `sqshq/piggymetrics` 项目为载体，达成2个目的：

1. 本地启动项目 
2. 容器化部署项目

参考资料：

- [学习Spring Cloud之本地部署](https://www.yuanqingfei.com/2021-12-27%20学习Spring%20Cloud之本地部署/)

# 版本说明

版本适配是项目首要关注点，关乎环境搭建。版本虽着语言、组件、框架等的升级，可能存在项目与版本不相适配问题，导致项目工程无法启动、部署。

| 组件/语言/框架/工具 |        版本        |
| :-----------------: | :----------------: |
|        Java         |        `8`         |
|     SpringBoot      |  `2.0.3.RELEASE`   |
|     SpringCloud     | `Finchley.RELEASE` |
|       MongoDB       |      `5.0.5`       |
|      RabbitMQ       |      `3.9.11`      |
|        IDEA         |     `2022.3.1`     |

- [https://docs.spring.io/spring-data/mongodb/docs/3.2.4/reference/html/#preface](https://docs.spring.io/spring-data/mongodb/docs/3.2.4/reference/html/#preface) mongodb版本适配
- [https://docs.spring.io/spring-data/mongodb/docs/3.2.4/reference/html/#compatibility.matrix](https://docs.spring.io/spring-data/mongodb/docs/3.2.4/reference/html/#compatibility.matrix) 兼容性适配

# 本地启动项目

## 环境准备

### 部署 MongDB

```shell
#安装
docker pull mongodb:latest

#运行
docker run -itd --name mongodb -p 27017:27017 mongo:latest --auth
docker run --name mongodb-with-auth \
  -e MONGO_INITDB_ROOT_USERNAME=user \
  -e MONGO_INITDB_ROOT_PASSWORD=password \
  -d mongo:latest --authenticationDatabase=admin
  
#进入容器
docker ps 
docker exec -it 镜像ID /bin/bash

#登录
mongo -u user -p password

#查看数据库
show dbs

#选择admin
use admin

#配置账户密码 docker exec 进入容器内执行语句配置账户密码
db.createUser( { user: "user",
                 pwd: "password",  
                 roles: [ { role: "clusterAdmin", db: "admin" },
                          { role: "readAnyDatabase", db: "admin" },
                          "readWrite"] },
               { w: "majority" , wtimeout: 5000 } );
#验证
db.antu('user','password')
```

### 部署 RabbitMQ

```shell
#安装
docker pull rabbitmq:latest

#运行
docker run -d --hostname rabbitmq --name rabbit -p 15672:15672 -p 5672:5672 rabbitmq

#进容器内
docker ps 
docker exec -it 镜像ID /bin/bash

#安装控制台
rabbitmq-plugins enable rabbitmq_management
```

访问：[http://localhost:15672](http://localhost:15672) ， 账户/密码：guest/guest

![image-20240419181359991](https://cdn.jsdelivr.net/gh/zhengzhenning/imageBeds@main/images/image-20240419181359991.png)

### 安装 IDEA插件

- 安装 [EnvFile](https://plugins.jetbrains.com/plugin/7861-envfile) 插件

### 调整配置文件



## 启动服务



## 问题记录

连接 `MongoDB` 失败，报 `MongoSecurityException`，参考[这篇](https://howtodoinjava.com/mongodb/command-failed-with-error-18/)。

![image-20240419160749189](https://cdn.jsdelivr.net/gh/zhengzhenning/imageBeds@main/images/image-20240419160749189.png)

在 `shared/account-service.yml` 指定 `authentication-database` 配置：

```
spring:
  data:
    mongodb:
#      host: account-mongodb
      # 本地环境
      host: localhost
      username: user
      password: password
      database: piggymetrics
      # 指定鉴权数据库
      authentication-database: admin
      port: 27017
```

